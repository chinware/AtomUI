<Project>
    <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk"/>
    <Import Project="$(MSBuildThisFileDirectory)../../build/Common.props"/>
    <Import Project="$(MSBuildThisFileDirectory)../../build/PackageMetaInfo.props"/>
    <Import Project="$(MSBuildThisFileDirectory)../../build/AtomUINativePackageInfo.props"/>
    <PropertyGroup>
        <TargetFramework>net8.0</TargetFramework>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    </PropertyGroup>

    <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk"/>

    <ItemGroup>
        <PackageReference Include="Avalonia"/>
    </ItemGroup>

    <ItemGroup>
        <InternalsVisibleTo Include="AtomUI.Base"/>
        <InternalsVisibleTo Include="AtomUI.Controls"/>
    </ItemGroup>

    <PropertyGroup>
        <AtomUINavtiveBuildPath>$([System.IO.Path]::Combine($(MSBuildProjectDirectory), $(IntermediateOutputPath), 'AtomUINative'))</AtomUINavtiveBuildPath>
        <AtomUINativeSrcPath>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)/../../nativelibs'))</AtomUINativeSrcPath>
    </PropertyGroup>

    <ItemGroup>
        <AtomUINativeSources Include="$(AtomUINativeSrcPath)/include/**/*.*"/>
        <AtomUINativeSources Include="$(AtomUINativeSrcPath)/src/**/*.*"/>
        <AtomUINativeArtifact Include="$(OutputPath)$(AtomUINativeDeployPath)/$(AtomUINativeArtifactName)"/>
    </ItemGroup>

    <Choose>
        <When Condition="'$(Configuration)' == 'Debug'">
            <PropertyGroup>
                <CMakeBuildType>Debug</CMakeBuildType>
            </PropertyGroup>
        </When>
        <Otherwise>
            <PropertyGroup>
                <CMakeBuildType>Release</CMakeBuildType>
            </PropertyGroup>
        </Otherwise>
    </Choose>

    <Target Name="BildAtomUINative"
            BeforeTargets="Build"
            Inputs="@(AtomUINativeSources)"
            Outputs="@(AtomUINativeArtifact)">
        <Message Text="@(AtomUINativeArtifact)" Importance="high"/>
        <PropertyGroup>
            <CPUCount>$([System.Environment]::ProcessorCount)</CPUCount>
        </PropertyGroup>
        <MakeDir Directories="$(AtomUINavtiveBuildPath)" Condition="!Exists('$(AtomUINavtiveBuildPath)')"/>
        <Exec Command="cmake -B $(AtomUINavtiveBuildPath) -S $(AtomUINativeSrcPath) --install-prefix $(OutputPath) -DCMAKE_BUILD_TYPE=$(CMakeBuildType) -G Ninja"
              WorkingDirectory="$(AtomUINavtiveBuildPath)"
              ConsoleToMsBuild="true"
        >
            <Output TaskParameter="ConsoleOutput" PropertyName="CmakeOutput"/>
            <Output TaskParameter="ExitCode" PropertyName="BildAtomUINativeExitCode"/>
        </Exec>
        <Exec Command="ninja -j $(CPUCount) -C $(AtomUINavtiveBuildPath)"
              WorkingDirectory="$(AtomUINavtiveBuildPath)"
              ConsoleToMsBuild="true"
        />

        <Exec Command="ninja install"
              WorkingDirectory="$(AtomUINavtiveBuildPath)"
              ConsoleToMsBuild="true"
        />
        <Copy SourceFiles="$(OutputPath)lib/$(AtomUINativeArtifactName)" DestinationFolder="$(OutputPath)$(AtomUINativeDeployPath)"/>

        <ItemGroup Condition="'$(Configuration)' == 'Release'">
            <Content Include="@(AtomUINativeArtifact)">
                <Link>$(AtomUINativeArtifactName)</Link>
                <PackagePath>$(AtomUINativeDeployPath)</PackagePath>
                <Pack>true</Pack>
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
        </ItemGroup>
        
    </Target>

</Project>