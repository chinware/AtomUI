<Project>
    <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk"/>
    <Import Project="$(MSBuildThisFileDirectory)../../build/AtomUINativePackageInfo.props"/>
    <PropertyGroup>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    </PropertyGroup>

    <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk"/>

    <ItemGroup>
        <PackageReference Include="Avalonia"/>
    </ItemGroup>

    <ItemGroup>
        <InternalsVisibleTo Include="AtomUI.Base"/>
        <InternalsVisibleTo Include="AtomUI.Controls"/>
    </ItemGroup>

    <PropertyGroup>
        <AtomUINavtiveBuildPath>$([System.IO.Path]::Combine($(MSBuildProjectDirectory), $(IntermediateOutputPathWithoutFramework), 'AtomUINative'))</AtomUINavtiveBuildPath>
        <AtomUINativeSrcPath>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)/../../nativelibs'))</AtomUINativeSrcPath>
        <AtomUITempInstallPrefix>$([System.IO.Path]::GetFullPath('$(OutputPathWithoutFramework)'))</AtomUITempInstallPrefix>
        <AtomUINativeAbsoluteDeployPath>$(OutputPathWithoutFramework)$(AtomUINativeDeployPath)</AtomUINativeAbsoluteDeployPath>
        <AtomUIBuildPwShScript>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)/../../scripts/BuildAtomUINative.ps1'))</AtomUIBuildPwShScript>
        
        <AtomUINativeWindowsX64Artifact>$(OutputPathWithoutFramework)$(AtomUINativeWindowsX64DeployPath)/$(AtomUINativeWindowsArtifactName)</AtomUINativeWindowsX64Artifact>
        <AtomUINativeMacOSArtifact>$(OutputPathWithoutFramework)$(AtomUINativeMacOSDeployPath)/$(AtomUINativeMacOSArtifactName)</AtomUINativeMacOSArtifact>
        <AtomUINativeCompiledMarker>$(AtomUINavtiveBuildPath)/.native_compiled</AtomUINativeCompiledMarker>
    </PropertyGroup>

    <ItemGroup>
        <AtomUINativeSources Include="$(AtomUINativeSrcPath)/include/**/*.*"/>
        <AtomUINativeSources Include="$(AtomUINativeSrcPath)/src/**/*.*"/>
        <AtomUINativeArtifact Include="$(OutputPathWithoutFramework)$(AtomUINativeDeployPath)/$(AtomUINativeArtifactName)"/>
    </ItemGroup>

    <Choose>
        <When Condition="'$(Configuration)' == 'Debug'">
            <PropertyGroup>
                <CMakeBuildType>Debug</CMakeBuildType>
            </PropertyGroup>
        </When>
        <Otherwise>
            <PropertyGroup>
                <CMakeBuildType>Release</CMakeBuildType>
            </PropertyGroup>
        </Otherwise>
    </Choose>

    <Target Name="BuildAtomUINative"
            BeforeTargets="BeforeBuild"
            Inputs="@(AtomUINativeSources)"
            Outputs="@(AtomUINativeArtifact)">
        <PropertyGroup>
            <CPUCount>$([System.Environment]::ProcessorCount)</CPUCount>
        </PropertyGroup>
        <MakeDir Directories="$(AtomUINavtiveBuildPath)" Condition="!Exists('$(AtomUINavtiveBuildPath)')"/>
        <MakeDir Directories="$(AtomUITempInstallPrefix)" Condition="!Exists('$(AtomUITempInstallPrefix)')"/>
        <MakeDir Directories="$(AtomUINativeAbsoluteDeployPath)" Condition="!Exists('$(AtomUINativeAbsoluteDeployPath)')"/>
        <Exec Command='pwsh -NonInteractive -executionpolicy Unrestricted $(AtomUIBuildPwShScript) -buildDir "$(AtomUINavtiveBuildPath)" -sourceDir "$(AtomUINativeSrcPath)" -installPrefix "$(AtomUITempInstallPrefix.TrimEnd("\"))" -deployDir "$(AtomUINativeAbsoluteDeployPath)" -buildType "$(CMakeBuildType)" -libName "$(AtomUINativeArtifactName)"'
              WorkingDirectory="$(AtomUINavtiveBuildPath)"
              ConsoleToMsBuild="true"
        />
        
    </Target>

    <Target Name="BuildAtomUINativeCacheFile" AfterTargets="Clean">
        <Delete Files="@(AtomUINativeCompiledMarker)" />
    </Target>

</Project>