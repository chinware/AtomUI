<Project>
    <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk"/>
    <Import Project="$(MSBuildThisFileDirectory)../../build/Common.props"/>
    <Import Project="$(MSBuildThisFileDirectory)../../build/PackageMetaInfo.props"/>
    <Import Project="$(MSBuildThisFileDirectory)../../build/AtomUINativePackageInfo.props"/>
    <PropertyGroup>
        <TargetFramework>net8.0</TargetFramework>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    </PropertyGroup>

    <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk"/>

    <ItemGroup>
        <PackageReference Include="Avalonia"/>
    </ItemGroup>

    <ItemGroup>
        <InternalsVisibleTo Include="AtomUI.Base"/>
        <InternalsVisibleTo Include="AtomUI.Controls"/>
    </ItemGroup>

    <PropertyGroup>
        <AtomUINavtiveBuildPath>$([System.IO.Path]::Combine($(MSBuildProjectDirectory), $(IntermediateOutputPath), 'AtomUINative'))</AtomUINavtiveBuildPath>
        <AtomUINativeSrcPath>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)/../../nativelibs'))</AtomUINativeSrcPath>
        <AtomUITempInstallPrefix>$([System.IO.Path]::GetFullPath('$(OutputPath)'))</AtomUITempInstallPrefix>
        <AtomUINativeAbsoluteDeployPath>$(OutputPath)$(AtomUINativeDeployPath)</AtomUINativeAbsoluteDeployPath>
        <AtomUIBuildPwShScript>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)/../../scripts/BuildAtomUINative.ps1'))</AtomUIBuildPwShScript>
    </PropertyGroup>

    <ItemGroup>
        <AtomUINativeSources Include="$(AtomUINativeSrcPath)/include/**/*.*"/>
        <AtomUINativeSources Include="$(AtomUINativeSrcPath)/src/**/*.*"/>
        <AtomUINativeArtifact Include="$(OutputPath)$(AtomUINativeDeployPath)/$(AtomUINativeArtifactName)"/>
    </ItemGroup>

    <Choose>
        <When Condition="'$(Configuration)' == 'Debug'">
            <PropertyGroup>
                <CMakeBuildType>Debug</CMakeBuildType>
            </PropertyGroup>
        </When>
        <Otherwise>
            <PropertyGroup>
                <CMakeBuildType>Release</CMakeBuildType>
            </PropertyGroup>
        </Otherwise>
    </Choose>

    <Target Name="BildAtomUINative"
            BeforeTargets="Build"
            Inputs="@(AtomUINativeSources)"
            Outputs="@(AtomUINativeArtifact)">
        <PropertyGroup>
            <CPUCount>$([System.Environment]::ProcessorCount)</CPUCount>
            <PowerShellExecutable Condition="$([MSBuild]::IsOSPlatform('OSX'))">pwsh</PowerShellExecutable>
            <PowerShellExecutable Condition="$([MSBuild]::IsOSPlatform('Linux'))">pwsh</PowerShellExecutable>
            <PowerShellExecutable Condition="$([MSBuild]::IsOSPlatform('Windows'))">powershell</PowerShellExecutable>
        </PropertyGroup>
        <MakeDir Directories="$(AtomUINavtiveBuildPath)" Condition="!Exists('$(AtomUINavtiveBuildPath)')"/>
        <MakeDir Directories="$(AtomUITempInstallPrefix)" Condition="!Exists('$(AtomUITempInstallPrefix)')"/>
        <MakeDir Directories="$(AtomUINativeAbsoluteDeployPath)" Condition="!Exists('$(AtomUINativeAbsoluteDeployPath)')"/>
        <Exec Command='$(PowerShellExecutable) -NonInteractive -executionpolicy Unrestricted $(AtomUIBuildPwShScript) -buildDir "$(AtomUINavtiveBuildPath)" -sourceDir "$(AtomUINativeSrcPath)" -installPrefix "$(AtomUITempInstallPrefix.TrimEnd("\"))" -deployDir "$(AtomUINativeAbsoluteDeployPath)" -buildType "$(CMakeBuildType)" -libName "$(AtomUINativeArtifactName)"'
              WorkingDirectory="$(AtomUINavtiveBuildPath)"
              ConsoleToMsBuild="true"
        />

        <ItemGroup Condition="'$(Configuration)' == 'Release'">
            <Content Include="@(AtomUINativeArtifact)">
                <Link>$(AtomUINativeArtifactName)</Link>
                <PackagePath>$(AtomUINativeDeployPath)</PackagePath>
                <Pack>true</Pack>
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
        </ItemGroup>
        
    </Target>

</Project>